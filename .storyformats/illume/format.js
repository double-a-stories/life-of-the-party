window.storyFormat({
	"name":"Illume",
	"version":"1.0.5",
	"author":"<a href=\"http://twitter.com/gnustoboz\">Michael McCollum</a>",
	"description":"Free proofing format integrating basic workflow features for collaborative work.",
	"image":"icon.svg",
	"url":"https://maximumverbosity.net/twine/Illume/",
	"license":"MIT License (http://opensource.org/licenses/MIT)",
	"proofing":true,
	"source":"<html>\n<head>\n<title>{{STORY_NAME}} (Illuminated)</title>\n<style type=\"text/css\">\nhtml { box-sizing: border-box;}\n*, *:before, *:after { box-sizing: inherit;}\n\nhtml, body {\nmargin: 0px;\npadding: 0px;\nfont-family:'Open Sans', 'Source Code Pro', 'Deja Vu Sans', 'Arial', sans-serif;\nfont-size: 12pt;\n}\n\ninput {\nfont-family:'Open Sans', 'Source Code Pro', 'Deja Vu Sans', 'Arial', sans-serif;\n}\n\n#header {\nborder: 1px solid #990;\nwidth: 100%;\nheight: 35px;\nfont-size: 12pt;\nfont-weight: bold;\nbackground: #36c;\ncolor: #eef;\npadding: 5px;\n}\n\n#workspace {\nposition: absolute;\ntop: 35px;\nleft: 0;\nright: 0;\nbottom: 25px;\n}\n\n#sidebar {\nposition: absolute;\nleft: 0;\ntop: 0px;\nbottom: 0px;\nwidth: 250px;\nborder-right: 1px solid #999;\nbackground: #eee;\n}\n#sidebar span {\ndisplay: inline-block;\nwidth: 100%;\ntext-decoration: none;\ncolor: #009;\ncursor: pointer;\n}\n#sidebar span:hover {\nbackground: #ffc;\ntext-decoration: underline;\n}\n#links {\nheight: 120px;\nfont-size: 10pt;\npadding: 4px;\n}\n#passageListHeader {\nwidth: 100%;\nheight: 25px;\npadding: 0px;\n}\n#filter {\nfont-size: 10pt;\nfont-weight: bold;\nmargin: 0px;\npadding: 0px;\nwidth: 100%;\nheight: 25px;\nborder: 0px;\nborder-top: 1px solid #999;\nborder-bottom: 1px solid #999;\nbackground: #ddf;\n}\n#filter:focus {\noutline: none;\nbox-shadow: none;\n}\n#passageListContent {\nposition: absolute;\ntop: 145px;\nbottom: 0;\nleft: 0;\nwidth: 250px;\noverflow: auto;\npadding: 4px;\nfont-size: 10pt;\n}\n.flag {\ndisplay: inline-block;\nfloat: right;\nwidth: 15px;\nheight: 15px;\nfont-size: 7pt;\ntext-align: center;\nfont-weight: bold;\nmargin: 2px 2px 0px 0px;\n}\n.reviewed {\nborder: 1px solid #090;\nbackground: #bfb;\nborder-radius: 5px;\n}\n.changed {\nborder: 1px solid #900;\nbackground: #fbb;\nborder-radius: 7px;\n}\n\n\n#contentArea { \nheight: 99%;\nmargin-left: 250px;\npadding: 5px 5px 5px 10px;\noverflow: auto;\n}\n\n\n#generalOutput {\ndisplay: none;\n}\n#generalHeader {\nheight: 35px;\npadding: 2px;\nborder-bottom: 1px solid #999;\n}\n#generalTitle {\ndisplay: inline-block;\nfont-weight: bold;\nfont-size: 16pt;\n}\n\n.infoTile {\ndisplay: inline-block;\nfloat: left;\noverflow: auto;\nborder: 1px solid #999;\nborder-radius: 5px;\nmargin: 10px 10px 0px 0px;\n}\n.tile1x1 {\nwidth: 200px;\nheight: 250px;\n}\n.tile2x1 {\nwidth: 410px;\nheight: 250px;\n}\n.tile1x2 {\nwidth: 200px;\nheight: 510px;\n}\n.tile2x2 {\nwidth: 410px;\nheight: 510px;\n}\n.infoTile .title {\nbackground: #ddf;\ndisplay: block;\nfont-weight: bold;\nborder-bottom: 1px solid #999;\npadding: 1px 2px 1px 4px;\n}\n\n.infoTile .content {\nfont-size: 8pt;\n}\n.infoTile p {\nmargin: 0px;\npadding: 4px;\nline-height: 150%;\n}\n.infoTile table {\nborder-spacing: 0px;\nwidth: 100%;\nfont-size: 8pt;\n}\n.infoTile table tr.header td {\nbackground: #eee;\nborder-bottom: 1px solid #999;\nfont-weight: bold;\n}\n.infoTile table td {\npadding: 2px;\nmargin: 0px;\ntext-align: right;\npadding-right: 4px;\nborder-left: 1px solid #999;\n}\n.infoTile table td:nth-of-type(1) {\nborder-left: 0px;\npadding-left: 4px;\ntext-align: left;\n}\n.infoTile span.link {\ndisplay: inline-block;\nwidth: 100%;\ntext-decoration: none;\ncolor: #009;\ncursor: pointer;\n}\n.infoTile span.link:hover {\nbackground: #ffc;\ntext-decoration: underline;\n}\n\n\n\n#passageViewer {\ndisplay: none;\n}\n#passageHeader {\nheight: 35px;\npadding: 2px;\nborder-bottom: 1px solid #999;\n}\n#passageTitle {\ndisplay: inline-block;\nfont-weight: bold;\nfont-size: 16pt;\n}\n#passageTags {\nposition: absolute;\ntop: 0;\ndisplay: inline-block;\npadding: 0px 0px 0px 15px;\nmargin-top: 10px;\n}\n\n#passageControls {\ndisplay: block;\nfont-size: 9pt;\nborder-bottom: 1px solid #999;\nbackground: #eee;\nheight: 25px;\npadding: 2px 5px 1px 5px;\n}\n#passageControls input {\nfont-size: 8pt;\n}\n#dirtyControls {\nfloat: right;\ndisplay: none;\n}\n#reviewedControls {\ndisplay: none;\n}\n#unreviewedControls {\ndisplay: none;\n}\n\n#passageContent {\nposition: absolute;\ntop: 60px;\nbottom: 0;\nleft: 260px;\nright: 0;\n}\n/* #editor {\nmargin-top: 5px;\nfont-size: 14pt;\nposition: absolute;\ntop: 0;\nbottom: 0;\nleft: 0;\nwidth: 100%;\nresize: vertical;\nmargin-bottom: 400px;\nborder: 0px;\n} */\n#editor {\nfont-size: 14pt;\nwidth: 100%;\nheight: 99%;\nresize: none;\n}\n#editorCorral {\nmargin-top: 5px;\nposition: absolute;\ntop: 0;\nbottom: 0;\nleft: 0;\nwidth: 100%;\nborder: 0px;\n}\n\n#editor:focus {\noutline: 0px;\n}\n#changeViewer {\nfont-size: 10pt;\nwhite-space: pre-wrap;\ndisplay: none;\nborder-top: 1px dashed #999;\npadding-top: 10px;\nposition: absolute;\nbottom: 0;\nleft: 0;\nright: 0;\nwidth: 100%;\nheight: 300px;\noverflow: auto;\n}\n\n.tag {\nborder: 1px solid #cc9;\npadding: 1px 5px 1px 5px;\nmargin-right: 4px;\nmargin-bottom: 3px;\nbackground: #fea;\ncolor: #660;\nborder-radius: 3px;\nfont-size: 9pt;\ncursor: pointer;\n}\n\nins {\nbackground: #9f9;\n}\n\ndel {\nbackground: #f99;\n}\n\n#footer {\nposition: absolute;\nheight: 25px;\nbottom: 0;\nleft: 0;\nright: 0;\nfont-weight: bold;\nbackground: #36c;\ncolor: #eef;\nfont-size: 12pt;\npadding: 1px 4px 0px 4px;\n}\n#footer input {\nfont-weight: bold;\nfont-size: 8pt;\n}\n#footerLeft {\n}\n#footerRight {\nfloat: right;\n}\n</style>\n<script type=\"text/javascript\">\n/**\n * Diff Match and Patch\n *\n * Copyright 2006 Google Inc.\n * http://code.google.com/p/google-diff-match-patch/\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */(function(){function diff_match_patch(){this.Diff_Timeout=1;this.Diff_EditCost=4;this.Match_Threshold=0.5;this.Match_Distance=1E3;this.Patch_DeleteThreshold=0.5;this.Patch_Margin=4;this.Match_MaxBits=32}\ndiff_match_patch.prototype.diff_main=function(a,b,c,d){\"undefined\"==typeof d&&(d=0>=this.Diff_Timeout?Number.MAX_VALUE:(new Date).getTime()+1E3*this.Diff_Timeout);if(null==a||null==b)throw Error(\"Null input. (diff_main)\");if(a==b)return a?[[0,a]]:[];\"undefined\"==typeof c&&(c=!0);var e=c,f=this.diff_commonPrefix(a,b);c=a.substring(0,f);a=a.substring(f);b=b.substring(f);var f=this.diff_commonSuffix(a,b),g=a.substring(a.length-f);a=a.substring(0,a.length-f);b=b.substring(0,b.length-f);a=this.diff_compute_(a,\nb,e,d);c&&a.unshift([0,c]);g&&a.push([0,g]);this.diff_cleanupMerge(a);return a};\ndiff_match_patch.prototype.diff_compute_=function(a,b,c,d){if(!a)return[[1,b]];if(!b)return[[-1,a]];var e=a.length>b.length?a:b,f=a.length>b.length?b:a,g=e.indexOf(f);return-1!=g?(c=[[1,e.substring(0,g)],[0,f],[1,e.substring(g+f.length)]],a.length>b.length&&(c[0][0]=c[2][0]=-1),c):1==f.length?[[-1,a],[1,b]]:(e=this.diff_halfMatch_(a,b))?(f=e[0],a=e[1],g=e[2],b=e[3],e=e[4],f=this.diff_main(f,g,c,d),c=this.diff_main(a,b,c,d),f.concat([[0,e]],c)):c&&100<a.length&&100<b.length?this.diff_lineMode_(a,b,\nd):this.diff_bisect_(a,b,d)};\ndiff_match_patch.prototype.diff_lineMode_=function(a,b,c){var d=this.diff_linesToChars_(a,b);a=d.chars1;b=d.chars2;d=d.lineArray;a=this.diff_main(a,b,!1,c);this.diff_charsToLines_(a,d);this.diff_cleanupSemantic(a);a.push([0,\"\"]);for(var e=d=b=0,f=\"\",g=\"\";b<a.length;){switch(a[b][0]){case 1:e++;g+=a[b][1];break;case -1:d++;f+=a[b][1];break;case 0:if(1<=d&&1<=e){a.splice(b-d-e,d+e);b=b-d-e;d=this.diff_main(f,g,!1,c);for(e=d.length-1;0<=e;e--)a.splice(b,0,d[e]);b+=d.length}d=e=0;g=f=\"\"}b++}a.pop();return a};\ndiff_match_patch.prototype.diff_bisect_=function(a,b,c){for(var d=a.length,e=b.length,f=Math.ceil((d+e)/2),g=f,h=2*f,j=Array(h),i=Array(h),k=0;k<h;k++)j[k]=-1,i[k]=-1;j[g+1]=0;i[g+1]=0;for(var k=d-e,q=0!=k%2,r=0,t=0,p=0,w=0,v=0;v<f&&!((new Date).getTime()>c);v++){for(var n=-v+r;n<=v-t;n+=2){var l=g+n,m;m=n==-v||n!=v&&j[l-1]<j[l+1]?j[l+1]:j[l-1]+1;for(var s=m-n;m<d&&s<e&&a.charAt(m)==b.charAt(s);)m++,s++;j[l]=m;if(m>d)t+=2;else if(s>e)r+=2;else if(q&&(l=g+k-n,0<=l&&l<h&&-1!=i[l])){var u=d-i[l];if(m>=\nu)return this.diff_bisectSplit_(a,b,m,s,c)}}for(n=-v+p;n<=v-w;n+=2){l=g+n;u=n==-v||n!=v&&i[l-1]<i[l+1]?i[l+1]:i[l-1]+1;for(m=u-n;u<d&&m<e&&a.charAt(d-u-1)==b.charAt(e-m-1);)u++,m++;i[l]=u;if(u>d)w+=2;else if(m>e)p+=2;else if(!q&&(l=g+k-n,0<=l&&(l<h&&-1!=j[l])&&(m=j[l],s=g+m-l,u=d-u,m>=u)))return this.diff_bisectSplit_(a,b,m,s,c)}}return[[-1,a],[1,b]]};\ndiff_match_patch.prototype.diff_bisectSplit_=function(a,b,c,d,e){var f=a.substring(0,c),g=b.substring(0,d);a=a.substring(c);b=b.substring(d);f=this.diff_main(f,g,!1,e);e=this.diff_main(a,b,!1,e);return f.concat(e)};\ndiff_match_patch.prototype.diff_linesToChars_=function(a,b){function c(a){for(var b=\"\",c=0,f=-1,g=d.length;f<a.length-1;){f=a.indexOf(\"\\\\n\",c);-1==f&&(f=a.length-1);var r=a.substring(c,f+1),c=f+1;(e.hasOwnProperty?e.hasOwnProperty(r):void 0!==e[r])?b+=String.fromCharCode(e[r]):(b+=String.fromCharCode(g),e[r]=g,d[g++]=r)}return b}var d=[],e={};d[0]=\"\";var f=c(a),g=c(b);return{chars1:f,chars2:g,lineArray:d}};\ndiff_match_patch.prototype.diff_charsToLines_=function(a,b){for(var c=0;c<a.length;c++){for(var d=a[c][1],e=[],f=0;f<d.length;f++)e[f]=b[d.charCodeAt(f)];a[c][1]=e.join(\"\")}};diff_match_patch.prototype.diff_commonPrefix=function(a,b){if(!a||!b||a.charAt(0)!=b.charAt(0))return 0;for(var c=0,d=Math.min(a.length,b.length),e=d,f=0;c<e;)a.substring(f,e)==b.substring(f,e)?f=c=e:d=e,e=Math.floor((d-c)/2+c);return e};\ndiff_match_patch.prototype.diff_commonSuffix=function(a,b){if(!a||!b||a.charAt(a.length-1)!=b.charAt(b.length-1))return 0;for(var c=0,d=Math.min(a.length,b.length),e=d,f=0;c<e;)a.substring(a.length-e,a.length-f)==b.substring(b.length-e,b.length-f)?f=c=e:d=e,e=Math.floor((d-c)/2+c);return e};\ndiff_match_patch.prototype.diff_commonOverlap_=function(a,b){var c=a.length,d=b.length;if(0==c||0==d)return 0;c>d?a=a.substring(c-d):c<d&&(b=b.substring(0,c));c=Math.min(c,d);if(a==b)return c;for(var d=0,e=1;;){var f=a.substring(c-e),f=b.indexOf(f);if(-1==f)return d;e+=f;if(0==f||a.substring(c-e)==b.substring(0,e))d=e,e++}};\ndiff_match_patch.prototype.diff_halfMatch_=function(a,b){function c(a,b,c){for(var d=a.substring(c,c+Math.floor(a.length/4)),e=-1,g=\"\",h,j,n,l;-1!=(e=b.indexOf(d,e+1));){var m=f.diff_commonPrefix(a.substring(c),b.substring(e)),s=f.diff_commonSuffix(a.substring(0,c),b.substring(0,e));g.length<s+m&&(g=b.substring(e-s,e)+b.substring(e,e+m),h=a.substring(0,c-s),j=a.substring(c+m),n=b.substring(0,e-s),l=b.substring(e+m))}return 2*g.length>=a.length?[h,j,n,l,g]:null}if(0>=this.Diff_Timeout)return null;\nvar d=a.length>b.length?a:b,e=a.length>b.length?b:a;if(4>d.length||2*e.length<d.length)return null;var f=this,g=c(d,e,Math.ceil(d.length/4)),d=c(d,e,Math.ceil(d.length/2)),h;if(!g&&!d)return null;h=d?g?g[4].length>d[4].length?g:d:d:g;var j;a.length>b.length?(g=h[0],d=h[1],e=h[2],j=h[3]):(e=h[0],j=h[1],g=h[2],d=h[3]);h=h[4];return[g,d,e,j,h]};\ndiff_match_patch.prototype.diff_cleanupSemantic=function(a){for(var b=!1,c=[],d=0,e=null,f=0,g=0,h=0,j=0,i=0;f<a.length;)0==a[f][0]?(c[d++]=f,g=j,h=i,i=j=0,e=a[f][1]):(1==a[f][0]?j+=a[f][1].length:i+=a[f][1].length,e&&(e.length<=Math.max(g,h)&&e.length<=Math.max(j,i))&&(a.splice(c[d-1],0,[-1,e]),a[c[d-1]+1][0]=1,d--,d--,f=0<d?c[d-1]:-1,i=j=h=g=0,e=null,b=!0)),f++;b&&this.diff_cleanupMerge(a);this.diff_cleanupSemanticLossless(a);for(f=1;f<a.length;){if(-1==a[f-1][0]&&1==a[f][0]){b=a[f-1][1];c=a[f][1];\nd=this.diff_commonOverlap_(b,c);e=this.diff_commonOverlap_(c,b);if(d>=e){if(d>=b.length/2||d>=c.length/2)a.splice(f,0,[0,c.substring(0,d)]),a[f-1][1]=b.substring(0,b.length-d),a[f+1][1]=c.substring(d),f++}else if(e>=b.length/2||e>=c.length/2)a.splice(f,0,[0,b.substring(0,e)]),a[f-1][0]=1,a[f-1][1]=c.substring(0,c.length-e),a[f+1][0]=-1,a[f+1][1]=b.substring(e),f++;f++}f++}};\ndiff_match_patch.prototype.diff_cleanupSemanticLossless=function(a){function b(a,b){if(!a||!b)return 6;var c=a.charAt(a.length-1),d=b.charAt(0),e=c.match(diff_match_patch.nonAlphaNumericRegex_),f=d.match(diff_match_patch.nonAlphaNumericRegex_),g=e&&c.match(diff_match_patch.whitespaceRegex_),h=f&&d.match(diff_match_patch.whitespaceRegex_),c=g&&c.match(diff_match_patch.linebreakRegex_),d=h&&d.match(diff_match_patch.linebreakRegex_),i=c&&a.match(diff_match_patch.blanklineEndRegex_),j=d&&b.match(diff_match_patch.blanklineStartRegex_);\nreturn i||j?5:c||d?4:e&&!g&&h?3:g||h?2:e||f?1:0}for(var c=1;c<a.length-1;){if(0==a[c-1][0]&&0==a[c+1][0]){var d=a[c-1][1],e=a[c][1],f=a[c+1][1],g=this.diff_commonSuffix(d,e);if(g)var h=e.substring(e.length-g),d=d.substring(0,d.length-g),e=h+e.substring(0,e.length-g),f=h+f;for(var g=d,h=e,j=f,i=b(d,e)+b(e,f);e.charAt(0)===f.charAt(0);){var d=d+e.charAt(0),e=e.substring(1)+f.charAt(0),f=f.substring(1),k=b(d,e)+b(e,f);k>=i&&(i=k,g=d,h=e,j=f)}a[c-1][1]!=g&&(g?a[c-1][1]=g:(a.splice(c-1,1),c--),a[c][1]=\nh,j?a[c+1][1]=j:(a.splice(c+1,1),c--))}c++}};diff_match_patch.nonAlphaNumericRegex_=/[^a-zA-Z0-9]/;diff_match_patch.whitespaceRegex_=/\\s/;diff_match_patch.linebreakRegex_=/[\\\\r\\\\n]/;diff_match_patch.blanklineEndRegex_=/\\\\n\\\\r?\\\\n$/;diff_match_patch.blanklineStartRegex_=/^\\\\r?\\\\n\\\\r?\\\\n/;\ndiff_match_patch.prototype.diff_cleanupEfficiency=function(a){for(var b=!1,c=[],d=0,e=null,f=0,g=!1,h=!1,j=!1,i=!1;f<a.length;){if(0==a[f][0])a[f][1].length<this.Diff_EditCost&&(j||i)?(c[d++]=f,g=j,h=i,e=a[f][1]):(d=0,e=null),j=i=!1;else if(-1==a[f][0]?i=!0:j=!0,e&&(g&&h&&j&&i||e.length<this.Diff_EditCost/2&&3==g+h+j+i))a.splice(c[d-1],0,[-1,e]),a[c[d-1]+1][0]=1,d--,e=null,g&&h?(j=i=!0,d=0):(d--,f=0<d?c[d-1]:-1,j=i=!1),b=!0;f++}b&&this.diff_cleanupMerge(a)};\ndiff_match_patch.prototype.diff_cleanupMerge=function(a){a.push([0,\"\"]);for(var b=0,c=0,d=0,e=\"\",f=\"\",g;b<a.length;)switch(a[b][0]){case 1:d++;f+=a[b][1];b++;break;case -1:c++;e+=a[b][1];b++;break;case 0:1<c+d?(0!==c&&0!==d&&(g=this.diff_commonPrefix(f,e),0!==g&&(0<b-c-d&&0==a[b-c-d-1][0]?a[b-c-d-1][1]+=f.substring(0,g):(a.splice(0,0,[0,f.substring(0,g)]),b++),f=f.substring(g),e=e.substring(g)),g=this.diff_commonSuffix(f,e),0!==g&&(a[b][1]=f.substring(f.length-g)+a[b][1],f=f.substring(0,f.length-\ng),e=e.substring(0,e.length-g))),0===c?a.splice(b-d,c+d,[1,f]):0===d?a.splice(b-c,c+d,[-1,e]):a.splice(b-c-d,c+d,[-1,e],[1,f]),b=b-c-d+(c?1:0)+(d?1:0)+1):0!==b&&0==a[b-1][0]?(a[b-1][1]+=a[b][1],a.splice(b,1)):b++,c=d=0,f=e=\"\"}\"\"===a[a.length-1][1]&&a.pop();c=!1;for(b=1;b<a.length-1;)0==a[b-1][0]&&0==a[b+1][0]&&(a[b][1].substring(a[b][1].length-a[b-1][1].length)==a[b-1][1]?(a[b][1]=a[b-1][1]+a[b][1].substring(0,a[b][1].length-a[b-1][1].length),a[b+1][1]=a[b-1][1]+a[b+1][1],a.splice(b-1,1),c=!0):a[b][1].substring(0,\na[b+1][1].length)==a[b+1][1]&&(a[b-1][1]+=a[b+1][1],a[b][1]=a[b][1].substring(a[b+1][1].length)+a[b+1][1],a.splice(b+1,1),c=!0)),b++;c&&this.diff_cleanupMerge(a)};diff_match_patch.prototype.diff_xIndex=function(a,b){var c=0,d=0,e=0,f=0,g;for(g=0;g<a.length;g++){1!==a[g][0]&&(c+=a[g][1].length);-1!==a[g][0]&&(d+=a[g][1].length);if(c>b)break;e=c;f=d}return a.length!=g&&-1===a[g][0]?f:f+(b-e)};\ndiff_match_patch.prototype.diff_prettyHtml=function(a){for(var b=[],c=/&/g,d=/</g,e=/>/g,f=/\\\\n/g,g=0;g<a.length;g++){var h=a[g][0],j=a[g][1],j=j.replace(c,\"&amp;\").replace(d,\"&lt;\").replace(e,\"&gt;\").replace(f,\"&para;<br>\");switch(h){case 1:b[g]='<ins style=\"background:#e6ffe6;\">'+j+\"</ins>\";break;case -1:b[g]='<del style=\"background:#ffe6e6;\">'+j+\"</del>\";break;case 0:b[g]=\"<span>\"+j+\"</span>\"}}return b.join(\"\")};\ndiff_match_patch.prototype.diff_text1=function(a){for(var b=[],c=0;c<a.length;c++)1!==a[c][0]&&(b[c]=a[c][1]);return b.join(\"\")};diff_match_patch.prototype.diff_text2=function(a){for(var b=[],c=0;c<a.length;c++)-1!==a[c][0]&&(b[c]=a[c][1]);return b.join(\"\")};diff_match_patch.prototype.diff_levenshtein=function(a){for(var b=0,c=0,d=0,e=0;e<a.length;e++){var f=a[e][0],g=a[e][1];switch(f){case 1:c+=g.length;break;case -1:d+=g.length;break;case 0:b+=Math.max(c,d),d=c=0}}return b+=Math.max(c,d)};\ndiff_match_patch.prototype.diff_toDelta=function(a){for(var b=[],c=0;c<a.length;c++)switch(a[c][0]){case 1:b[c]=\"+\"+encodeURI(a[c][1]);break;case -1:b[c]=\"-\"+a[c][1].length;break;case 0:b[c]=\"=\"+a[c][1].length}return b.join(\"\\t\").replace(/%20/g,\" \")};\ndiff_match_patch.prototype.diff_fromDelta=function(a,b){for(var c=[],d=0,e=0,f=b.split(/\\t/g),g=0;g<f.length;g++){var h=f[g].substring(1);switch(f[g].charAt(0)){case \"+\":try{c[d++]=[1,decodeURI(h)]}catch(j){throw Error(\"Illegal escape in diff_fromDelta: \"+h);}break;case \"-\":case \"=\":var i=parseInt(h,10);if(isNaN(i)||0>i)throw Error(\"Invalid number in diff_fromDelta: \"+h);h=a.substring(e,e+=i);\"=\"==f[g].charAt(0)?c[d++]=[0,h]:c[d++]=[-1,h];break;default:if(f[g])throw Error(\"Invalid diff operation in diff_fromDelta: \"+\nf[g]);}}if(e!=a.length)throw Error(\"Delta length (\"+e+\") does not equal source text length (\"+a.length+\").\");return c};diff_match_patch.prototype.match_main=function(a,b,c){if(null==a||null==b||null==c)throw Error(\"Null input. (match_main)\");c=Math.max(0,Math.min(c,a.length));return a==b?0:a.length?a.substring(c,c+b.length)==b?c:this.match_bitap_(a,b,c):-1};\ndiff_match_patch.prototype.match_bitap_=function(a,b,c){function d(a,d){var e=a/b.length,g=Math.abs(c-d);return!f.Match_Distance?g?1:e:e+g/f.Match_Distance}if(b.length>this.Match_MaxBits)throw Error(\"Pattern too long for this browser.\");var e=this.match_alphabet_(b),f=this,g=this.Match_Threshold,h=a.indexOf(b,c);-1!=h&&(g=Math.min(d(0,h),g),h=a.lastIndexOf(b,c+b.length),-1!=h&&(g=Math.min(d(0,h),g)));for(var j=1<<b.length-1,h=-1,i,k,q=b.length+a.length,r,t=0;t<b.length;t++){i=0;for(k=q;i<k;)d(t,c+\nk)<=g?i=k:q=k,k=Math.floor((q-i)/2+i);q=k;i=Math.max(1,c-k+1);var p=Math.min(c+k,a.length)+b.length;k=Array(p+2);for(k[p+1]=(1<<t)-1;p>=i;p--){var w=e[a.charAt(p-1)];k[p]=0===t?(k[p+1]<<1|1)&w:(k[p+1]<<1|1)&w|((r[p+1]|r[p])<<1|1)|r[p+1];if(k[p]&j&&(w=d(t,p-1),w<=g))if(g=w,h=p-1,h>c)i=Math.max(1,2*c-h);else break}if(d(t+1,c)>g)break;r=k}return h};\ndiff_match_patch.prototype.match_alphabet_=function(a){for(var b={},c=0;c<a.length;c++)b[a.charAt(c)]=0;for(c=0;c<a.length;c++)b[a.charAt(c)]|=1<<a.length-c-1;return b};\ndiff_match_patch.prototype.patch_addContext_=function(a,b){if(0!=b.length){for(var c=b.substring(a.start2,a.start2+a.length1),d=0;b.indexOf(c)!=b.lastIndexOf(c)&&c.length<this.Match_MaxBits-this.Patch_Margin-this.Patch_Margin;)d+=this.Patch_Margin,c=b.substring(a.start2-d,a.start2+a.length1+d);d+=this.Patch_Margin;(c=b.substring(a.start2-d,a.start2))&&a.diffs.unshift([0,c]);(d=b.substring(a.start2+a.length1,a.start2+a.length1+d))&&a.diffs.push([0,d]);a.start1-=c.length;a.start2-=c.length;a.length1+=\nc.length+d.length;a.length2+=c.length+d.length}};\ndiff_match_patch.prototype.patch_make=function(a,b,c){var d;if(\"string\"==typeof a&&\"string\"==typeof b&&\"undefined\"==typeof c)d=a,b=this.diff_main(d,b,!0),2<b.length&&(this.diff_cleanupSemantic(b),this.diff_cleanupEfficiency(b));else if(a&&\"object\"==typeof a&&\"undefined\"==typeof b&&\"undefined\"==typeof c)b=a,d=this.diff_text1(b);else if(\"string\"==typeof a&&b&&\"object\"==typeof b&&\"undefined\"==typeof c)d=a;else if(\"string\"==typeof a&&\"string\"==typeof b&&c&&\"object\"==typeof c)d=a,b=c;else throw Error(\"Unknown call format to patch_make.\");\nif(0===b.length)return[];c=[];a=new diff_match_patch.patch_obj;for(var e=0,f=0,g=0,h=d,j=0;j<b.length;j++){var i=b[j][0],k=b[j][1];!e&&0!==i&&(a.start1=f,a.start2=g);switch(i){case 1:a.diffs[e++]=b[j];a.length2+=k.length;d=d.substring(0,g)+k+d.substring(g);break;case -1:a.length1+=k.length;a.diffs[e++]=b[j];d=d.substring(0,g)+d.substring(g+k.length);break;case 0:k.length<=2*this.Patch_Margin&&e&&b.length!=j+1?(a.diffs[e++]=b[j],a.length1+=k.length,a.length2+=k.length):k.length>=2*this.Patch_Margin&&\ne&&(this.patch_addContext_(a,h),c.push(a),a=new diff_match_patch.patch_obj,e=0,h=d,f=g)}1!==i&&(f+=k.length);-1!==i&&(g+=k.length)}e&&(this.patch_addContext_(a,h),c.push(a));return c};diff_match_patch.prototype.patch_deepCopy=function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c],e=new diff_match_patch.patch_obj;e.diffs=[];for(var f=0;f<d.diffs.length;f++)e.diffs[f]=d.diffs[f].slice();e.start1=d.start1;e.start2=d.start2;e.length1=d.length1;e.length2=d.length2;b[c]=e}return b};\ndiff_match_patch.prototype.patch_apply=function(a,b){if(0==a.length)return[b,[]];a=this.patch_deepCopy(a);var c=this.patch_addPadding(a);b=c+b+c;this.patch_splitMax(a);for(var d=0,e=[],f=0;f<a.length;f++){var g=a[f].start2+d,h=this.diff_text1(a[f].diffs),j,i=-1;if(h.length>this.Match_MaxBits){if(j=this.match_main(b,h.substring(0,this.Match_MaxBits),g),-1!=j&&(i=this.match_main(b,h.substring(h.length-this.Match_MaxBits),g+h.length-this.Match_MaxBits),-1==i||j>=i))j=-1}else j=this.match_main(b,h,g);\nif(-1==j)e[f]=!1,d-=a[f].length2-a[f].length1;else if(e[f]=!0,d=j-g,g=-1==i?b.substring(j,j+h.length):b.substring(j,i+this.Match_MaxBits),h==g)b=b.substring(0,j)+this.diff_text2(a[f].diffs)+b.substring(j+h.length);else if(g=this.diff_main(h,g,!1),h.length>this.Match_MaxBits&&this.diff_levenshtein(g)/h.length>this.Patch_DeleteThreshold)e[f]=!1;else{this.diff_cleanupSemanticLossless(g);for(var h=0,k,i=0;i<a[f].diffs.length;i++){var q=a[f].diffs[i];0!==q[0]&&(k=this.diff_xIndex(g,h));1===q[0]?b=b.substring(0,\nj+k)+q[1]+b.substring(j+k):-1===q[0]&&(b=b.substring(0,j+k)+b.substring(j+this.diff_xIndex(g,h+q[1].length)));-1!==q[0]&&(h+=q[1].length)}}}b=b.substring(c.length,b.length-c.length);return[b,e]};\ndiff_match_patch.prototype.patch_addPadding=function(a){for(var b=this.Patch_Margin,c=\"\",d=1;d<=b;d++)c+=String.fromCharCode(d);for(d=0;d<a.length;d++)a[d].start1+=b,a[d].start2+=b;var d=a[0],e=d.diffs;if(0==e.length||0!=e[0][0])e.unshift([0,c]),d.start1-=b,d.start2-=b,d.length1+=b,d.length2+=b;else if(b>e[0][1].length){var f=b-e[0][1].length;e[0][1]=c.substring(e[0][1].length)+e[0][1];d.start1-=f;d.start2-=f;d.length1+=f;d.length2+=f}d=a[a.length-1];e=d.diffs;0==e.length||0!=e[e.length-1][0]?(e.push([0,\nc]),d.length1+=b,d.length2+=b):b>e[e.length-1][1].length&&(f=b-e[e.length-1][1].length,e[e.length-1][1]+=c.substring(0,f),d.length1+=f,d.length2+=f);return c};\ndiff_match_patch.prototype.patch_splitMax=function(a){for(var b=this.Match_MaxBits,c=0;c<a.length;c++)if(!(a[c].length1<=b)){var d=a[c];a.splice(c--,1);for(var e=d.start1,f=d.start2,g=\"\";0!==d.diffs.length;){var h=new diff_match_patch.patch_obj,j=!0;h.start1=e-g.length;h.start2=f-g.length;\"\"!==g&&(h.length1=h.length2=g.length,h.diffs.push([0,g]));for(;0!==d.diffs.length&&h.length1<b-this.Patch_Margin;){var g=d.diffs[0][0],i=d.diffs[0][1];1===g?(h.length2+=i.length,f+=i.length,h.diffs.push(d.diffs.shift()),\nj=!1):-1===g&&1==h.diffs.length&&0==h.diffs[0][0]&&i.length>2*b?(h.length1+=i.length,e+=i.length,j=!1,h.diffs.push([g,i]),d.diffs.shift()):(i=i.substring(0,b-h.length1-this.Patch_Margin),h.length1+=i.length,e+=i.length,0===g?(h.length2+=i.length,f+=i.length):j=!1,h.diffs.push([g,i]),i==d.diffs[0][1]?d.diffs.shift():d.diffs[0][1]=d.diffs[0][1].substring(i.length))}g=this.diff_text2(h.diffs);g=g.substring(g.length-this.Patch_Margin);i=this.diff_text1(d.diffs).substring(0,this.Patch_Margin);\"\"!==i&&\n(h.length1+=i.length,h.length2+=i.length,0!==h.diffs.length&&0===h.diffs[h.diffs.length-1][0]?h.diffs[h.diffs.length-1][1]+=i:h.diffs.push([0,i]));j||a.splice(++c,0,h)}}};diff_match_patch.prototype.patch_toText=function(a){for(var b=[],c=0;c<a.length;c++)b[c]=a[c];return b.join(\"\")};\ndiff_match_patch.prototype.patch_fromText=function(a){var b=[];if(!a)return b;a=a.split(\"\\\\n\");for(var c=0,d=/^@@ -(\\d+),?(\\d*) \\+(\\d+),?(\\d*) @@$/;c<a.length;){var e=a[c].match(d);if(!e)throw Error(\"Invalid patch string: \"+a[c]);var f=new diff_match_patch.patch_obj;b.push(f);f.start1=parseInt(e[1],10);\"\"===e[2]?(f.start1--,f.length1=1):\"0\"==e[2]?f.length1=0:(f.start1--,f.length1=parseInt(e[2],10));f.start2=parseInt(e[3],10);\"\"===e[4]?(f.start2--,f.length2=1):\"0\"==e[4]?f.length2=0:(f.start2--,f.length2=\nparseInt(e[4],10));for(c++;c<a.length;){e=a[c].charAt(0);try{var g=decodeURI(a[c].substring(1))}catch(h){throw Error(\"Illegal escape in patch_fromText: \"+g);}if(\"-\"==e)f.diffs.push([-1,g]);else if(\"+\"==e)f.diffs.push([1,g]);else if(\" \"==e)f.diffs.push([0,g]);else if(\"@\"==e)break;else if(\"\"!==e)throw Error('Invalid patch mode \"'+e+'\" in: '+g);c++}}return b};diff_match_patch.patch_obj=function(){this.diffs=[];this.start2=this.start1=null;this.length2=this.length1=0};\ndiff_match_patch.patch_obj.prototype.toString=function(){var a,b;a=0===this.length1?this.start1+\",0\":1==this.length1?this.start1+1:this.start1+1+\",\"+this.length1;b=0===this.length2?this.start2+\",0\":1==this.length2?this.start2+1:this.start2+1+\",\"+this.length2;a=[\"@@ -\"+a+\" +\"+b+\" @@\\\\n\"];var c;for(b=0;b<this.diffs.length;b++){switch(this.diffs[b][0]){case 1:c=\"+\";break;case -1:c=\"-\";break;case 0:c=\" \"}a[b+1]=c+encodeURI(this.diffs[b][1])+\"\\\\n\"}return a.join(\"\").replace(/%20/g,\" \")};\nthis.diff_match_patch=diff_match_patch;this.DIFF_DELETE=-1;this.DIFF_INSERT=1;this.DIFF_EQUAL=0;})()</script>\n<script type=\"text/javascript\">\n/**\n * Illume - Twine Proofing Story Format\n * \n * Copyright (c) 2015 Michael McCollum\n * http://www.maximumverbosity.net/twine/Illume/\n *\n * This license applies exclusively to the Illume story format for Twine 2. No ownership of, nor\n * licensing restrictions on, the content within the generated story are stated or implied.\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and\n * associated documentation files (the \"Software\"), to deal in the Software without restriction,\n * including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense,\n * and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so,\n * subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all copies or substantial\n * portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT\n * LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.\n * IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,\n * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\n * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n */\nwindow.onload = function() {\nif (typeof(window.Illume) == \"undefined\") {\n\n\nwindow.Illume = {\n\ninit: function() { \nIllume.UI.init();\nIllume.Editor.init();\nIllume.Diff.init();\nIllume.Story.init();\nIllume.Passages.init();\nIllume.Overview.init();\n\nthis.UI.updateList();\nthis.Overview.showStoryOverview();\n\n},\n\n\npopout:function(content) {\nvar w = window.open();\nw.document.write(content);\n},\n\ndownload:function(filename, text, contentType) {\nif (!contentType)\ncontentType = 'text/plain';\n\nwindow.URL = window.URL || window.webkitURL;\nvar dataBlob = new Blob([text], {type: contentType});\n\nvar downloader = document.createElement('a');\ndownloader.setAttribute('innerHtml', 'downloader');\ndownloader.setAttribute('href', window.URL.createObjectURL(dataBlob));\ndownloader.setAttribute('download', filename);\ndownloader.onclick = function() {\ndocument.body.removeChild(event.target);\n};\ndocument.body.appendChild(downloader);\ndownloader.click();\n},\n\nviewChangeList:function() {\nthis.generateChangeList(false);\n},\n\nsaveChangeList:function() {\nthis.generateChangeList(true);\n},\n\ngenerateChangeList:function(forExport) {\nvar buffer = [];\nvar diffs;\nvar p;\n\nvar matches = Illume.Passages.findPassages(function(p) { return p.changed;});\nvar title = Illume.Story.storyName + ' Change List - ' + (new Date()).toLocaleString();\n\nif (matches.length < 1) {\nalert('No changes have been made.');\nreturn '';\n}\n\nbuffer.push('<html><he','ad>');\nbuffer.push('<title>',title,'</title>');\nbuffer.push('<style type=\"text/css\">');\nbuffer.push('ins {background: #9f9;} del {background: #f99;}');\nbuffer.push(\"body{font-family:'Open Sans','Source Code Pro','Deja Vu Sans','Arial',sans-serif;}\");\nbuffer.push(\"h1{text-align:center;}\");\nbuffer.push(\"h2{margin:50px 0px 0px 10px;}\");\nbuffer.push(\"input{float:right;}\");\nbuffer.push(\"pre{margin: 0px;line-height: 175%;font-size: 12pt;border: solid #999;border-width: 1px 0px 1px 0px;}\");\nbuffer.push('</style>');\nbuffer.push('</he','ad><bo','dy>');\n\nbuffer.push('<h1>', title, '</h1>');\n\nfor (var i in matches) {\np = matches[i];\ndiffs = window.Illume.Diff.diff(this.encodeEntities(p.originalContent), this.encodeEntities(p.content));\n\nbuffer.push('<div id=\"p.' + p.id + '\">');\nbuffer.push('<input type=\"button\" value=\"Done\" onclick=\"this.parentNode.remove(this);\" />');\nbuffer.push(\"<h2>\", p.name, \"</h2>\");\nbuffer.push(\"<pre>\", window.Illume.Diff.formatDiffs(diffs),\"</pre>\");\nbuffer.push(\"</div>\");\n}\n\nbuffer.push('</bo', 'dy></html>');\n\nvar output = buffer.join('');\n\nif (forExport) {\nthis.download(title + '.html', output, 'text/html');\n} else {\nthis.popout(output);\n}\n\n},\n\nencodeEntities:function(s) {\nreturn String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;');\n},\n\nexportTwee: function() {\nthis.download(Illume.Story.storyName + \".tw\", Illume.Entweedle.export(), 'text/plain');\n},\n\nsaveToFile:function() {\nalert(\"Note: the saved file will be a fresh copy of this illumination and will not include any changes you've made to this version.\");\nthis.download(Illume.Story.storyName + \" (Illuminated).html\", window.document.documentElement.innerHTML, 'text/html');\n}\n\n\n}\n\n\nwindow.Illume.Overview = {\nintroText: '',\ntips: '',\n\ninit:function() {\nthis.introText = window.document.getElementById('introText').innerHTML;\nthis.tips = window.document.getElementById('tips').innerHTML;\n},\n\nshowStoryOverview:function() {\nIllume.Story.compileStats();\n\nvar buffer = [];\n\nbuffer.push(this.generateTile(\"Welcome to Illume\", Illume.Overview.introText,'2x1'));\nbuffer.push(this.generateTile(\"Stats\", this.generateTable(Illume.Story.generateStorySummary()) + '<p>These do not reflect changes made during review or by macros during play.</p>'));\nbuffer.push(this.generateTile(\"Review Summary\", this.generateTable(Illume.Passages.generateReviewSummary())));\n\nbuffer.push(this.generateTile(\"Passage Summary\", this.generateTable(Illume.Passages.generateSummary()),'2x1'));\nbuffer.push(this.generateTile(\"Tags\", this.generateTable(Illume.Story.getTagSummary(), true),'1x1'));\n\nbuffer.push(this.generateTile(\"Tips\", Illume.Overview.tips));\n\n\nIllume.UI.showGeneralOutput('Story Overview', buffer.join(''));\n},\n\ngenerateTile:function(title,content,size,classes) {\nvar buffer = [];\nif (!size)\nsize = '1x1';\n\nbuffer.push('<div class=\"infoTile tile', size, ' ', classes, '\"><div class=\"title\">');\nbuffer.push(title);\nbuffer.push('</div><div class=\"content\">');\nbuffer.push(content);\nbuffer.push('</div></div>');\n\nreturn buffer.join('');\n},\n\ngenerateTable:function(o, preserveLabels) {\nvar label,link,data;\nvar buffer = [];\nvar isHeader = false;\n\nbuffer.push(\"<table>\");\nfor (key in o) {\nlabel = key;\n\nif (label.indexOf(\"header.\") > -1) {\nlabel = label.substring(7);\nisHeader = true;\n} else {\nisHeader = false\n}\n\n\nif (!preserveLabels) {\nlabel = label.replace(/[A-Z][a-z]*/g, function(word) { return ' ' + word.charAt(0).toUpperCase() + word.substr(1);});\nlabel = label.charAt(0).toUpperCase() + label.substr(1);\n}\n\ndata = o[key];\n\nlink = data['illumeLink'];\n\nbuffer.push(\"<tr\");\nif (isHeader) {\nbuffer.push(' class=\"header\"');\n}\nbuffer.push(\"><td>\");\nif (link && link.length > 0) {\nbuffer.push('<span class=\"link\" onclick=\"' + link + '\">');\n}\nbuffer.push(label);\nif (link) {\nbuffer.push('</span>');\n}\nbuffer.push(\"</td>\");\nif (typeof data == \"object\") {\nfor (var i in data) {\nif (i == 'illumeLink')\ncontinue;\n\nbuffer.push('<td>', data[i], '</td>');\n}\n} else {\nbuffer.push('<td>', data, '</td>')\n}\nbuffer.push(\"</tr>\");\n}\nbuffer.push(\"</table>\");\n\nreturn buffer.join('');\n\n}\n}\n\n\nwindow.Illume.Diff = {\nlogic: null,\n\ninit:function() {\nthis.logic = new window.diff_match_patch();\n},\n\ndiff: function(s1, s2) {\nvar diffs = this.logic.diff_main(s1, s2);\nthis.cleanup(diffs);\nreturn diffs;\n},\n\ncleanup:function(diffs) {\nthis.logic.diff_cleanupSemantic(diffs);\n},\n\nformatDiffs:function(diffs) {\nvar html = [];\nvar i = 0;\nfor (var x = 0; x < diffs.length; x++) {\nvar op = diffs[x][0];    \nvar data = diffs[x][1];\nvar text = data;\nswitch (op) {\ncase window.DIFF_INSERT:\nhtml[x] = '<ins>' + text + '</ins>';\nbreak;\ncase window.DIFF_DELETE:\nhtml[x] = '<del>' + text + '</del>';\nbreak;\ncase window.DIFF_EQUAL:\nhtml[x] = '' + text + '';\nbreak;\n}\nif (op !== window.DIFF_DELETE) {\ni += data.length;\n}\n}\nreturn html.join('');\n}\n\n}\n\n\nwindow.Illume.UI = {\nfilter:null,\nfilterTag: null,\nbyTagOption: null,\npassageListContent: null,\npassageViewer: null,\ngeneralOutput: null,\n\ninit:function() {\nthis.filter = window.document.getElementById('filter');\nthis.byTagOption = window.document.getElementById('byTagOption');\nthis.passageListContent = window.document.getElementById('passageListContent');\nthis.passageViewer = window.document.getElementById('passageViewer');\nthis.generalOutput = window.document.getElementById('generalOutput');\n},\n\nfilterChanged: function() {\nif (this.filter.value == 'byTag') {\nthis.filterTag = null;\n}\nthis.updateList();\n},\n\nfilterByTag:function(tag) {\nthis.filterTag = tag;\nthis.filter.value = 'byTag';\nthis.updateList();\n},\n\nupdateFilterList:function() {\nthis.byTagOption.textContent = \"By Tag...\";\n},\n\nswitchFilter:function(value) {\nthis.filter.value = value;\nthis.updateList();\n},\n\n\nupdateList:function() {\nvar matches = {};\n\nif (this.filter.value == 'unreviewed') {\nmatches = Illume.Passages.findPassages(function(p) { return !p.reviewed;});\n} else if (this.filter.value == 'reviewed') {\nmatches = Illume.Passages.findPassages(function(p) { return p.reviewed;});\n} else if (this.filter.value == 'changed') {\nmatches = Illume.Passages.findPassages(function(p) { return p.changed;});\n} else if (this.filter.value == 'unchanged') {\nmatches = Illume.Passages.findPassages(function(p) { return !p.changed;});\n} else if (this.filter.value == 'orphans') {\nmatches = Illume.Passages.findPassages(function(p) { return (p.inboundLinks == 0)});\n} else if (this.filter.value == 'deadEnds') {\nmatches = Illume.Passages.findPassages(function(p) { return (p.links == 0)});\n} else if (this.filter.value == 'passThroughs') {\nmatches = Illume.Passages.findPassages(function(p) { return (p.links == 1 && p.inboundLinks == 1)});\n} else if (this.filter.value == 'all') {\nmatches = Illume.Passages.getAll();\n} else if (this.filter.value == 'byTag') {\nif (!this.filterTag)\nthis.filterTag = window.prompt(\"Show passages with tag:\");\nif (!this.filterTag)\nreturn;\n\nthis.byTagOption.textContent = \"By Tag... [\" + this.filterTag + \"]\";\n\nmatches = Illume.Passages.findByTag(this.filterTag);\n}\n\nthis.passageListContent.innerHTML = '';\n\nvar buffer = [];\n\nfor (var i in matches) {\nbuffer.push(\"<span onclick=\\\"window.Illume.UI.showPassage('\", matches[i].id, \"');\\\">\");\nif (matches[i].reviewed) {\nbuffer.push('<div class=\"flag reviewed\">R</div>');\n}\nif (matches[i].changed) {\nbuffer.push('<div class=\"flag changed\">C</div>');\n}\nbuffer.push(matches[i].name);\nbuffer.push(\"</span>\");\n}\n\nthis.passageListContent.innerHTML = buffer.join('');\n\nthis.updateFooter();\n},\n\nupdateFooter:function() {\nvar footerLeft = window.document.getElementById('footerLeft');\nvar footerRight = window.document.getElementById('footerRight');\n\nvar reviewed = Illume.Passages.countPassages(function(p) { return p.reviewed;});\nvar changed = Illume.Passages.countPassages(function(p) { return p.changed;});\nvar total = Illume.Passages.passageCount;\nvar remaining = total - reviewed;\nvar reviewedPercentage = Math.ceil((reviewed / total) * 100);\n\nvar buffer = [];\n\nif (remaining > 0) {\nbuffer.push(reviewed, ' reviewed, ');\nbuffer.push(remaining, ' remaining');\nbuffer.push(\" (\");\n}\nbuffer.push(reviewedPercentage, '% reviewed');\nif (remaining > 0) {\nbuffer.push(')');\n}\n\nfooterLeft.innerHTML = buffer.join('');\n\nbuffer = [];\n\nif (changed > 0) {\nbuffer.push(changed);\nbuffer.push(' changed <input type=\"button\" id=\"footerChangeListButton\" value=\"Show Change List\" onclick=\"Illume.viewChangeList()\">');\n}\n\nfooterRight.innerHTML = buffer.join('');\n\n\n\n},\n\nshowGeneralOutput:function(title, content) {\nvar header = window.document.getElementById('generalTitle');\nvar body = window.document.getElementById('generalContent');\n\nheader.innerHTML = title;\nbody.innerHTML = content;\n\ngeneralOutput.style.display = 'block';\npassageViewer.style.display = 'none';\n},\n\nshowPassage:function(id) {\nvar p = Illume.Passages.getPassage(id);\n\nif (!p) {\nalert(id + ' not found');\nreturn;\n}\n\nwindow.document.getElementById(\"passageTitle\").textContent = p.name;\n\nvar tagContainer = window.document.getElementById(\"passageTags\");\n\ntagContainer.innerHTML = '';\n\nvar buffer = [];\nfor (var i in p.tags) {\nif (p.tags[i]) {\nbuffer.push(\"<span class=\\\"tag\\\" onclick=\\\"window.Illume.UI.filterByTag('\");\nbuffer.push(p.tags[i]);\nbuffer.push(\"');\\\">\");\nbuffer.push(p.tags[i]);\nbuffer.push(\"</span>\");\n}\n}\n\ntagContainer.innerHTML = buffer.join('');\n\nIllume.Editor.editPassage(id);\n\ngeneralOutput.style.display = 'none';\npassageViewer.style.display = 'block';\n\n}\n\n\n}\n\n\nwindow.Illume.Editor = {\neditor:null,\ncurrentPassageID: null,\ncurrentPassage: null,\nchangeViewer: null,\ncontrols: null,\nchangesShown: false,\n\ninit:function() {\nthis.editor = window.document.getElementById('editor');\nthis.controls = window.document.getElementById('passageControls');\nthis.changeViewer = window.document.getElementById('changeViewer');\n\nthis.editor.onchange = this.changeHandler;\nthis.editor.onkeyup = this.inputHandler;\n},\n\neditPassage:function(id) {\nthis.currentPassageID = id;\nthis.currentPassage = Illume.Passages.getPassage(id);\n\nthis.editor.value = this.currentPassage.content;\nthis.updateControls();\n},\n\nsetReviewedHandler:function(isReviewed) {\nIllume.Editor.setReviewed(isReviewed);\n},\n\nsetReviewed:function(isReviewed) {\nif (this.currentPassage.reviewed != isReviewed) {\nthis.currentPassage.reviewed = isReviewed;\nthis.updateControls();\nIllume.UI.updateList();\n}\n},\n\nrevert:function() {\nthis.currentPassage.content = this.currentPassage.originalContent;\nthis.currentPassage.changed = false;\nthis.editPassage(this.currentPassageID);\nIllume.UI.updateList();\nthis.hideChanges();\n},\n\nupdateControls:function() {\nvar c = window.document.getElementById('dirtyControls');\nvar r = window.document.getElementById('reviewedControls');\nvar ur = window.document.getElementById('unreviewedControls');\n\nc.style.display = (this.currentPassage.changed) ? 'inline-block' : 'none';\nr.style.display = (this.currentPassage.reviewed) ? 'inline-block' : 'none';\nur.style.display = (!this.currentPassage.reviewed) ? 'inline-block' : 'none';\n\nthis.currentPassage.changed ? this.showChanges() : this.hideChanges();\n},\n\nshowChanges: function() {\nthis.updateChangeViewer(true);\nthis.updateChangeDiffs();\n},\n\nhideChanges:function() {\nthis.updateChangeViewer(false);\n},\n\ntoggleChanges:function() {\nthis.updateChangeViewer(!this.changesShown);\n},\n\nupdateChangeViewer:function(shown) {\nthis.changeViewer.style.display = (shown ? 'block' : 'none');\n//this.editor.style.bottom = (shown ? '300px' : '0px');   //DEBUG\nwindow.document.getElementById('editorCorral').style.bottom = (shown ? '300px' : '0px');\n\nthis.changesShown = shown;\nthis.updateChangeDiffs();\n},\n\nupdateChangeDiffs:function() {\nif (this.changesShown) {\nvar p = this.currentPassage;\nvar diffs = window.Illume.Diff.diff(Illume.encodeEntities(p.originalContent), Illume.encodeEntities(p.content));\nthis.changeViewer.innerHTML = window.Illume.Diff.formatDiffs(diffs);\n}\n},\n\nupdatePassage:function() {\nthis.currentPassage.content = this.editor.value;\n},\n\ninputHandler:function() {\nif (!Illume.Editor.currentPassage.changed) {\nIllume.Editor.currentPassage.changed = true;\nIllume.UI.updateList();\n}\nIllume.Editor.updatePassage();\nIllume.Editor.updateControls();\nIllume.Editor.updateChangeDiffs();\n},\n\nchangeHandler:function() {\nIllume.Editor.updatePassage();\nIllume.Editor.updateControls();\nIllume.Editor.updateChangeDiffs();\n}\n\n\n}\n\n\nwindow.Illume.Story = {\nstoryData:null,\nstoryName:'{{STORY_NAME}}',\nstoryFormat: '',\nstartPassage: 1,\nstats: {},\nwordCount: 0,\ntags: {},\n\ninit:function() {\nthis.loadStoryData();\n},\n\nloadStoryData:function() {\nvar storyDataElements = window.document.getElementsByTagName(\"tw-storydata\");\nif (storyDataElements.length > 0) {\nthis.storyData = storyDataElements[0];\nthis.storyFormat = this.storyData.getAttribute(\"format\");\nthis.startPassage = this.storyData.getAttribute(\"startnode\");\n}\n},\n\ncompileStats:function() {\nvar p;\n\nvar s = {\nformat: this.storyFormat,\npassageCount: Illume.Passages.passageCount,\nwordCount: this.wordCount,\norphans: Illume.Passages.countPassages( function(p) { return (p.inboundLinks < 1); }),\ndeadEnds: Illume.Passages.countPassages( function(p) { return (p.links < 1); }),\n'pass-throughs': Illume.Passages.countPassages( function(p) { return (p.links == 1 && p.inboundLinks == 1); }),\n\naverageLinks: Math.floor(Illume.Passages.averageConnectivity * 100) / 100 ,\naverageWords: Math.floor(Illume.Passages.averageLength * 100) / 100\n\n};\n\nthis.stats = s;\n},\n\ngenerateStorySummary:function() {\nvar result = Object.create(this.stats);\n\nresult['format'] = result.format;\nresult.orphans = {\nillumeLink:\"Illume.UI.switchFilter('orphans');\",\nvalue:result.deadEnds\n}\nresult.deadEnds = {\nillumeLink:\"Illume.UI.switchFilter('deadEnds');\",\nvalue:result.deadEnds\n}\nresult['pass-throughs'] = {\nillumeLink:\"Illume.UI.switchFilter('passThroughs');\",\nvalue:result['pass-throughs']\n}\nresult.passageCount = {\nillumeLink:\"Illume.UI.switchFilter('all');\",\nvalue:result.passageCount\n}\n\nreturn result;\n},\n\ngetTagSummary:function() {\nvar results = {\n\"header.Tag\": \"Occurences\"\n}\nvar label;\n\nfor (var t in this.tags) {\nlabel = \"<span class=\\\"tag\\\" onclick=\\\"window.Illume.UI.filterByTag('\" + t + \"');\\\">\" + t + \"</span>\";\nresults[label] = this.tags[t];\n}\n\nreturn results;\n}\n\n}\n\n\nwindow.Illume.Passages = {\npassages: [],\nlinkCount:{},\ndeadLinks:[],\npassageCount: 0,\naverageConnectivity: 0,\naverageLength: 0,\n\nbasePassage: {\nid:-1,\nname: \"Undefined\",\ntags: [],\nlinks: 0,\ninboundLinks: 0,\nconnections: 0,\nsugarcubeMacros: 0,\nharloweMacros: 0,\nharloweHooks: 0,\nwordCount: 0,\ncontent: '',\noriginalContent: '',\nreviewed: false,\nchanged: false\n},\n\n\ninit: function() {\nthis.loadPassages();\n},\n\ngetPassage: function(id) {\nreturn this.passages[id];\n},\n\ngetAll:function() {\nreturn this.passages.slice();\n},\n\nfindByTag:function(tag) {\nvar results = [];\nvar p;\n\nresults.length = 0;\nfor (var i = 0; i < this.passages.length; i++) {\np = this.passages[i];\nif (p && p.tags.indexOf(tag) > -1) {\nresults.push(p);\n}\n}\nreturn results;\n},\n\nfindByName:function(name) {\nvar p;\n\nfor (var i in this.passages) {\np = this.passages[i];\nif (p && p.name == name) {\nreturn p;\n}\n}\nreturn null;\n},\n\nfindPassages:function(checkFunction) {\nvar p;\nvar results = [];\n\nif (!checkFunction || typeof(checkFunction) != \"function\") {\nreturn -1;\n}\n\nfor (var i in this.passages) {\np = this.passages[i];\n\nif (checkFunction(p)) {\nresults.push(p);\n}\n}\n\nreturn results;\n},\n\ncountPassages:function(checkFunction) {\nvar results = this.findPassages(checkFunction);\nif (!results)\nreturn 0;\nelse\nreturn results.length;\n},\n\nloadPassages: function() {\nvar passageElements = window.document.getElementsByTagName(\"tw-passagedata\");\nvar e;\nvar p;\nvar tagString;\n\nlinkCount = {};\n\nvar matchers = {\nlinks:/[^`]\\[{2}(.*)\\]{2}(?=[^`])/g,\nsugarcubeMacros:/\\<{2}.*\\>{2}/g,\nharloweMacros:/[^`]\\([^\\W]*:.*\\)(?=[^`])/g,\nharloweHooks:/[^`\\[]\\[[^\\[\\]]*\\](?=[^`\\]])/g\n};\n\nthis.passages.length = 0;\nfor (var i = 0; i < passageElements.length; i++) {\np = Object.create(this.basePassage);\ne = passageElements[i];\n\ntagString = e.getAttribute(\"tags\").trim();\n\nif (!tagString || tagString.length < 1)\np.tags = [];\nelse \np.tags = tagString.split(\" \");\n\nif (p.tags.indexOf(\"illumeIgnore\") > -1) {\ncontinue;\n}\n\nif (p.tags.indexOf(\"illumeReviewed\") > -1) {\np.reviewed = true;\n}\n\np.id = e.getAttribute(\"pid\");\np.name = e.getAttribute(\"name\");\np.content = e.textContent;\np.originalContent = e.textContent;\np.strippedContent = e.textContent;\n\nfor (var j in matchers) {\np[j] = (p.content.match(matchers[j]) || []).length;\n}\n\nif (p.harloweMacros > 0)\np.strippedContent = p.strippedContent.replace(matchers.harloweMacros, '');\n\n\nif (p.sugarcubeMacros > 0)\np.strippedContent = p.strippedContent.replace(matchers.sugarcubeMacros, '');\n\nvar re, match, destination;\n\nre = matchers.links;\nre.lastIndex = 0;\n\nvar destinations = [];\n\n\nwhile ((match = re.exec(' ' + p.content + ' ')) !== null) {\ndestination = match[1];\n\nif (destination.indexOf(\"->\") > -1) {\n//harlowe right link\ndestination = destination.substring(destination.indexOf(\"->\") + 2);\n} else if (destination.indexOf(\"<-\") > -1) {\n//harlowe left link\ndestination = destination.substring(0, destination.indexOf(\"<-\"));\n} else if (destination.indexOf(\"|\") > -1) {\n//sugarcube link\ndestination = destination.substring(destination.indexOf(\"|\") + 1);\n}\n\nif (destinations.indexOf(destination) < 0)\ndestinations.push(destination);\n}\n\n\nfor (var d in destinations) {\n//alert('adding a link from ' + p.name + ' to ' + destinations[d]);\nif (linkCount[destinations[d]])\n++linkCount[destinations[d]];\nelse\nlinkCount[destinations[d]] = 1;\n}\n\np.wordCount = p.strippedContent.trim().replace(/\\s+/g, ' ').split(' ').length;\n\nthis.passages[p.id] = p;\n}\n\n\nvar killList = [];\nvar connectivityTotal = 0;\nthis.passageCount = 0\nIllume.Story.wordCount = 0;\nIllume.Story.tags = {};\n\nfor (var i in this.passages) {\np = this.passages[i];\np.inboundLinks = (linkCount[p.name] || 0);\np.connections = p.links + p.inboundLinks;\nkillList.push(p.name);\n\nIllume.Story.wordCount += p.wordCount;\nconnectivityTotal += p.connections;\n++this.passageCount;\n\nfor (var t in p.tags) {\nif (!Illume.Story.tags[p.tags[t]])\nIllume.Story.tags[p.tags[t]] = 1;\nelse\n++Illume.Story.tags[p.tags[t]];\n}\n}\n\nfor (var n in killList) {\ndelete(linkCount[killList[n]]);\n}\n\nthis.averageLength = Illume.Story.wordCount / this.passageCount;\nthis.averageConnectivity = connectivityTotal / this.passageCount;\n\nthis.deadLinks = linkCount;\n},\n\ngenerateSummary:function() {\nvar ps = this.passages.slice();\nvar results = {};\nvar p;\n\nps.sort(function(a,b) {\nif (a.connections < b.connections)\nreturn 1;\nif (a.connections > b.connections)\nreturn -1;\nreturn 0;\n});\n\nresults[\"header.Passage\"] = [\n'Length',\n'Links (In/Out)'\n];\n\nfor (var i in ps) {\np = ps[i];\nresults[p.name] = {\nillumeLink:\"Illume.UI.showPassage('\" + p.id + \"');\",\nwordCount: p.wordCount,\nconnections: p.connections + \" (\" + p.inboundLinks + \"/\" + p.links + \")\"\n};\n}\n\nreturn results;\n},\n\ngenerateReviewSummary:function() {\nvar result = {};\nvar reviewed = this.countPassages(function(p) { return p.reviewed;});\nvar changed = this.countPassages(function(p) { return p.changed;});\n\nresult['totalPassages'] = {\nillumeLink:\"window.Illume.UI.switchFilter('all');\",\nvalue: this.passageCount\n}\nresult['changed'] = {\nillumeLink:\"window.Illume.UI.switchFilter('changed');\",\nvalue: changed\n};\nresult['reviewed'] = {\nillumeLink:\"window.Illume.UI.switchFilter('reviewed');\",\nvalue:reviewed\n};\nresult['reviewCompleted'] = {\nillumeLink:\"window.Illume.UI.switchFilter('unreviewed');\",\nvalue:Math.ceil(reviewed / this.passageCount * 100) + '%'\n};\n\n\n\nreturn result;\n}\n\n}\n\n\nwindow.Illume.Entweedle = {\n\nexport: function() {\nvar output = window.document.getElementById(\"output\");\nvar buffer = [];\n\nvar storyData = window.document.getElementsByTagName(\"tw-storydata\");\nif (storyData) {\nbuffer.push(this.buildPassage(\"StoryTitle\",\"\",storyData[0].getAttribute(\"name\")));\n}\nvar userScript = window.document.getElementById(\"twine-user-script\");\nif (userScript) {\nbuffer.push(this.buildPassage(\"UserScript\",\"script\",userScript.innerHTML));\n}\n\nvar userStylesheet = window.document.getElementById(\"twine-user-stylesheet\");\nif (userStylesheet) {\nbuffer.push(this.buildPassage(\"UserStylesheet\",\"stylesheet\",userStylesheet.innerHTML));\n}\n\nvar passages = window.document.getElementsByTagName(\"tw-passagedata\");\nfor (var i = 0; i < passages.length; i++) {\nbuffer.push(this.buildPassageFromElement(passages[i]));\n}\n\nreturn buffer.join('');\n},\n\n\nbuildPassageFromElement: function(passage) {\nvar name = passage.getAttribute(\"name\");\nif (!name) {\nname = \"Untitled Passage\";\n}\nvar tags = passage.getAttribute(\"tags\");\nvar content = passage.textContent;\n\nreturn this.buildPassage(name, tags, content);\n},\n\nbuildPassage: function(title, tags, content) {\nvar result = [];\n\nresult.push(\":: \",title);\nif (tags) {\nresult.push(\"[\",tags,\"]\");\n}\nresult.push(\"\\r\\n\", this.scrub(content),\"\\r\\n\\r\\n\");\n\nreturn result.join('');\n},\n\nscrub: function(content) {\ncontent = content.replace(/^::/gm, \" ::\");\nreturn content;\n}\n}\n\n\nwindow.Illume.init();\n}\n}\n\n</script>\n</head>\n<body>\n<div id=\"header\">\n{{STORY_NAME}}\n</div>\n<div id=\"workspace\">\n<div id=\"sidebar\">\n<div id=\"links\">\n<span onclick=\"window.Illume.Overview.showStoryOverview();\">Story Overview</span>\n<span onclick=\"window.Illume.viewChangeList();\">View Change List</span>\n<span onclick=\"window.Illume.saveChangeList();\">Export Change List...</span>\n<span onclick=\"window.Illume.exportTwee();\">Export Twee Source</span>\n<span onclick=\"window.Illume.saveToFile();\">Export Illumination...</span>\n</div>\n<div id=\"passageListHeader\">\n<select id=\"filter\" oninput=\"window.Illume.UI.updateFilterList();\" onchange=\"window.Illume.UI.filterChanged();\">\n<option value=\"unreviewed\">Unreviewed</option>\n<option value=\"reviewed\">Reviewed</option>\n<option value=\"changed\">Changed</option>\n<option value=\"unchanged\">Unchanged</option>\n<option value=\"orphans\">Orphans</option>\n<option value=\"deadEnds\">Dead Ends</option>\n<option value=\"passThroughs\">Pass-Throughs</option>\n<option id=\"byTagOption\" value=\"byTag\">By Tag...</option>\n<option value=\"all\">All Passages</option>\n</select>\n</div>\n<div id=\"passageListContent\"></div>\n</div>\n<div id=\"contentArea\">\n<div id=\"generalOutput\">\n<div id=\"generalHeader\">\n<div id=\"generalTitle\"></div>\n</div>\n<div id=\"generalContent\"></div>\n</div>\n<div id=\"passageViewer\">\n<div id=\"passageHeader\">\n<div id=\"passageTitle\"></div>\n<div id=\"passageTags\"></div>\n</div>\n<div id=\"passageControls\">\n<div id=\"dirtyControls\">\nModified <input id=\"revertChangesButton\" type=\"button\" value=\"Revert\" onclick=\"Illume.Editor.revert();\" />\n</div>\n<div id=\"reviewedControls\">\nReviewed <input id=\"unreviewedButton\" type=\"button\" value=\"Flag as Unreviewed\" onclick=\"Illume.Editor.setReviewedHandler(false);\"/>\n</div>\n<div id=\"unreviewedControls\">\nUnreviewed <input id=\"reviewedButton\" type=\"button\" value=\"Flag as Reviewed\" onclick=\"Illume.Editor.setReviewedHandler(true);\"/>\n</div>\n</div>\n<div id=\"passageContent\">\n<div id=\"editorCorral\"><textarea id=\"editor\"></textarea></div>\n<div id=\"changeViewer\"></div>\n</div>\n</div>\n</div>\n</div>\n<div id=\"footer\">\n<div id=\"footerRight\"></div>\n<div id=\"footerLeft\"></div>\n</div>\n<div id=\"introText\" style=\"display: none;\">\n<p>\nThis is the Story Overview, from which you can find general information and statistics about your story.\n</p>\n<p>\nUse the list at the lower-left to filter and view the passages of your story, and click on a passage to open it in review mode. While reviewing a passage, you can make changes in-place, compare your changed version to the original, revert those changes if needed, and flag a passage as reviewed to help you keep track of which passages have been reviewed and which ones remain.\n</p>\n<p>\nYou can use the links at the top left to view a change list, which shows all changes made to all passages, or export it to a file. You can also save a copy of this illumination for later use, or export your story in twee source format.\n</p>\n<p>\nFor more information about Illume, visit the <a href=\"https://maximumverbosity.net/twine/Illume/\">Illume web site</a>.\n</p>\n</div>\n<div id=\"tips\" style=\"display: none;\">\n<p>\nTag a passage \"illumeIgnore\" and it will be totally ignored by Illume for all purposes.\n</p>\n<p>\nIf a passage is not being modified, tag it \"illumeReviewed\" to set its initial state to Reviewed. The editor can still refer back to it if needed.\n</p>\n</div>\n<div id=\"storyData\" style=\"display: none;\">\n{{STORY_DATA}}\n</div>\n</body>\n</html>"
});